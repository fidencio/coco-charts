name: Release Helm Chart

on:
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases and tags
  packages: write  # Required for pushing to GitHub Container Registry

jobs:
  release:
    name: Release Helm Chart
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install yq
        run: |
          echo "ðŸ“¦ Installing yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: Read and validate versions from Chart.yaml
        id: read_version
        run: |
          VERSION="$(yq '.version' Chart.yaml)"
          APP_VERSION="$(yq '.appVersion' Chart.yaml)"
          
          # Check version exists
          if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
            echo "âŒ Failed to read version from Chart.yaml"
            exit 1
          fi
          
          # Check appVersion exists
          if [ -z "${APP_VERSION}" ] || [ "${APP_VERSION}" = "null" ]; then
            echo "âŒ Failed to read appVersion from Chart.yaml"
            exit 1
          fi
          
          # Ensure version and appVersion are in sync
          if [ "${VERSION}" != "${APP_VERSION}" ]; then
            echo "âŒ version and appVersion in Chart.yaml must be in sync!"
            echo "   version:    ${VERSION}"
            echo "   appVersion: ${APP_VERSION}"
            echo ""
            echo "Please update Chart.yaml to have matching version and appVersion:"
            echo "  yq -i '.appVersion = .version' Chart.yaml"
            exit 1
          fi
          
          # Validate version format
          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid version format: ${VERSION}"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 1.0.0 or 1.0.0-rc.1)"
            exit 1
          fi
          
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "âœ… Version from Chart.yaml: ${VERSION}"
          echo "âœ… appVersion matches version: ${APP_VERSION}"
          echo "âœ… Version format is valid"
      
      - name: Check if tag already exists
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "âŒ Tag v${VERSION} already exists"
            exit 1
          fi
          echo "âœ… Tag v${VERSION} does not exist yet"
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'
      
      - name: Update Helm dependencies
        run: |
          echo "ðŸ“¦ Updating Helm dependencies..."
          helm dependency update
          echo "âœ… Helm dependencies updated"
          echo "ðŸ“‹ Dependencies will be included in the chart package"
      
      - name: Package Helm chart
        run: |
          echo "ðŸ“¦ Packaging Helm chart with dependencies..."
          helm package . --destination .cr-release-packages
          echo "âœ… Helm chart packaged"
          echo "ðŸ“‹ Package contents:"
          ls -lh .cr-release-packages/
          echo ""
          echo "ðŸ“‹ Verifying package includes dependencies:"
          tar -tzf .cr-release-packages/confidential-containers-*.tgz | head -20
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Push Helm chart to GHCR
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          CHART_PACKAGE="$(ls .cr-release-packages/confidential-containers-${VERSION}.tgz)"
          
          # Push to GHCR using Helm's OCI support
          helm push "${CHART_PACKAGE}" oci://ghcr.io/${{ github.repository_owner }}/charts
          
          echo "âœ… Helm chart pushed to ghcr.io/${{ github.repository_owner }}/charts/confidential-containers:${VERSION}"
      
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          
          # Get the previous tag
          PREVIOUS_TAG="$(git describe --tags --abbrev=0 2>/dev/null || echo "")"
          
          cat > release-notes.md <<EOF
          # Confidential Containers Helm Chart v${VERSION}
          
          ## Installation
          
          ### From OCI Registry (Recommended)
          
          \`\`\`bash
          # x86_64 (Intel/AMD)
          helm install coco oci://ghcr.io/${{ github.repository_owner }}/charts/confidential-containers \\
            --version ${VERSION} \\
            --namespace coco-system
          
          # s390x (IBM Z)
          helm install coco oci://ghcr.io/${{ github.repository_owner }}/charts/confidential-containers \\
            --version ${VERSION} \\
            -f https://raw.githubusercontent.com/${{ github.repository }}/v${VERSION}/values/kata-s390x.yaml \\
            --namespace coco-system
          
          # peer-pods (remote)
          helm install coco oci://ghcr.io/${{ github.repository_owner }}/charts/confidential-containers \\
            --version ${VERSION} \\
            -f https://raw.githubusercontent.com/${{ github.repository }}/v${VERSION}/values/kata-remote.yaml \\
            --namespace coco-system
          \`\`\`
          
          ## What's Included
          
          - **Chart Version**: ${VERSION}
          - **App Version**: ${VERSION}
          - **kata-deploy Version**: $(yq '.dependencies[] | select(.name == "kata-deploy") | .version' Chart.yaml | head -1)
          
          ## Supported Architectures
          
          - x86_64 (Intel/AMD with SNP, TDX, NVIDIA GPU support)
          - s390x (IBM Z with Secure Execution)
          - peer-pods (Cloud API Adaptor integration)
          
          ## Documentation
          
          - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/v${VERSION}/QUICKSTART.md)
          - [Full Documentation](https://github.com/${{ github.repository }}/blob/v${VERSION}/README.md)
          
          EOF
          
          if [ -n "${PREVIOUS_TAG}" ]; then
            echo "## Changes Since ${PREVIOUS_TAG}" >> release-notes.md
            echo "" >> release-notes.md
            git log --pretty=format:"- %s (%h)" "${PREVIOUS_TAG}..HEAD" >> release-notes.md
          fi
          
          cat release-notes.md
          echo "release_notes_file=release-notes.md" >> "${GITHUB_OUTPUT}"
      
      - name: Create and push tag
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          
          echo "âœ… Created and pushed tag v${VERSION}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.read_version.outputs.version }}
          name: v${{ steps.read_version.outputs.version }}
          body_path: release-notes.md
          files: .cr-release-packages/*.tgz
          prerelease: false
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release Summary
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          cat << EOF
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    RELEASE COMPLETED SUCCESSFULLY! ðŸŽ‰                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“¦ Release Version: v${VERSION}
          ðŸ·ï¸  Git Tag: v${VERSION}
          ðŸ“ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}
          
          ðŸ“¥ OCI Registry:
             ghcr.io/${{ github.repository_owner }}/charts/confidential-containers:${VERSION}
          
          ðŸš€ Installation Command:
             helm install coco oci://ghcr.io/${{ github.repository_owner }}/charts/confidential-containers \\
               --version ${VERSION} \\
               --namespace coco-system
          
          âœ… Chart package available as release artifact
          âœ… Chart pushed to GitHub Container Registry
          âœ… Release notes generated
          âœ… Git tag created and pushed
          
          EOF

